VERSION 0.8
FROM ubuntu:lunar
IMPORT ./srs_db AS srs_db

RUN apt-get update && apt-get install -y \
  build-essential \
  curl \
  git \
  cmake \
  lsb-release \
  wget \
  software-properties-common \
  gnupg \
  ninja-build \
  npm \
  libssl-dev \
  jq \
  bash \
  libstdc++6 \
  clang-format

RUN wget https://apt.llvm.org/llvm.sh && chmod +x llvm.sh && ./llvm.sh 16
# let's not just spew files on /
WORKDIR /build
# WASM compiler, only redownload if this script changes
COPY ./scripts/install-wasi-sdk.sh ./scripts/install-wasi-sdk.sh
RUN ./scripts/install-wasi-sdk.sh

# minimum files to trigger rebuild
# keep timestamps for incremental builds
COPY --keep-ts src/barretenberg src/barretenberg
COPY --keep-ts src/CMakeLists.txt src/CMakeLists.txt
COPY --keep-ts CMakeLists.txt CMakeLists.txt
COPY --keep-ts cmake cmake
COPY --keep-ts CMakePresets.json CMakePresets.json

# Targets
build-ci:
    BUILD +build-release
    BUILD +build-wasm
    BUILD +build-gcc
    BUILD +build-fuzzing
    BUILD +build-clang-assert
    BUILD +test-clang-format

build-release:
    DO +BUILD --configure="--preset clang16" --build="--target ultra_honk_rounds_bench --target bb"

build-wasm:
    DO +BUILD --configure="--preset wasm-threads" --build="--target barretenberg.wasm"
    RUN ./src/wasi-sdk-20.0/bin/llvm-strip ./build/bin/barretenberg.wasm
    SAVE ARTIFACT build

build-gcc:
    DO +BUILD --configure="--preset gcc" --build=""

build-fuzzing:
    DO +BUILD --configure="--preset fuzzing" --build=""

build-clang-assert:
    DO +BUILD --configure="--preset clang16 -DCMAKE_BUILD_TYPE=RelWithAssert" --build=""

test-clang-format:
    COPY .clang-format .
    COPY format.sh .
    RUN ./format.sh check
    SAVE ARTIFACT build/bin

bench-ci:
    DO +BENCH --preset=clang16 --target=ultra_honk_bench
    DO +BENCH --preset=clang16 --target=client_ivc_bench
    DO +BENCH --preset=op-count-track --target=ultra_honk_bench
    DO +BENCH --preset=op-count-track --target=client_ivc_bench
    DO +BENCH --preset=op-count-time --target=client_ivc_bench
    DO +WASM_BENCH --target=ultra_honk_bench
    DO +WASM_BENCH --target=client_ivc_bench

# Functions
BUILD:
    FUNCTION
    ARG configure
    ARG build
    # builtin-arg, detects --ci
    ARG EARTHLY_CI
    IF [ $EARTHLY_CI ]
        # Don't cache CI builds.
        RUN cmake $configure -Bbuild && \
            cmake --build build $build
    ELSE
        # Use a mount for incremental builds locally.
        RUN --mount type=cache,id="$configure-build",target=/build/build \
            cmake $configure -Bbuild && \
            cmake --build build $build && \
            cp -r build/bin .
        # reconstruct build folder, as it was used in cache
        RUN mkdir build && mv bin build
    END
    SAVE ARTIFACT build

BENCH:
    FUNCTION
    ARG preset
    ARG target
    FROM +base
    DO +BUILD --configure="--preset $preset" --build="--target $target"
    COPY srs_db:+download/build srs_db
    RUN cd build && ./bin/$target

WASM_BENCH:
    FUNCTION
    ARG target
    FROM +base
    RUN curl https://wasmtime.dev/install.sh -sSf | bash
    DO +BUILD --configure="--preset wasm-threads" --build="--target $target"
    COPY srs_db:+download/build srs_db
    RUN cd build && ~/.wasmtime/bin/wasmtime run --env HARDWARE_CONCURRENCY=8 -Wthreads=y -Sthreads=y --dir=.. ./bin/$target
