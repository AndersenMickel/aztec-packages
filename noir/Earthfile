VERSION 0.8
FROM rust:bullseye
RUN apt update && apt install -y libc++1
WORKDIR /build

# Relevant source
COPY --keep-ts --dir \
  noir-repo/acvm-repo \
  noir-repo/aztec_macros \
  noir-repo/compiler \
  noir-repo/noir_stdlib \
  noir-repo/noirc_macros \
  noir-repo/tooling \
  noir-repo/test_programs \
  noir-repo/Cargo.lock \
  noir-repo/Cargo.toml \
  noir-repo

build:
    ARG EARTHLY_BUILD_SHA
    ENV COMMIT_HASH=$EARTHLY_BUILD_SHA
    COPY --keep-ts ./scripts/bootstrap_native.sh ./scripts/bootstrap_native.sh
    RUN ./scripts/bootstrap_native.sh
    SAVE ARTIFACT /build/noir-repo/target/release/nargo nargo
    SAVE ARTIFACT /build/noir-repo/target/release/acvm acvm

run:
    # When running the container, mount the users home directory to same location.
    FROM ubuntu:lunar
    # Install Tini as nargo doesn't handle signals properly.
    # Install git as nargo needs it to clone.
    RUN apt-get update && apt-get install -y git tini && rm -rf /var/lib/apt/lists/* && apt-get clean
    COPY +build/. /build
    ENTRYPOINT ["/usr/bin/tini", "--", "/build/nargo"]
