
#!/usr/bin/env bash
[ -n "${BUILD_SYSTEM_DEBUG:-}" ] && set -x # conditionally trace

set -eu

wget https://github.com/earthly/earthly/releases/latest/download/earthly-linux-amd64 -O ./earthly;
chmod +x ./earthly && ./earthly bootstrap --no-buildkit
# forward ports to the earthly runner on our docker host (TODO use env var)
ssh -o ExitOnForwardFailure=yes -f -N -L 8372:localhost:8372 ubuntu@18.191.162.117
# turn off tls as we're already working through SSH
./earthly config global.cache_size_mb 24000
./earthly config global.tls_enabled false
# Annoying workaround: we have to use a localhost earthly does NOT recognize otherwise it will try to use
# a locally managed buildkit. $(hostname) didn't work here on CirlceCI, so we pick a common other loopback (ip6-localhost).
./earthly --buildkit-host=tcp://ip6-localhost:8372 $@