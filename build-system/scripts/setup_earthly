
#!/usr/bin/env bash
[ -n "${BUILD_SYSTEM_DEBUG:-}" ] && set -x # conditionally trace
wget https://github.com/earthly/earthly/releases/latest/download/earthly-linux-amd64 -O ./earthly;
chmod +x ./earthly && ./earthly bootstrap;
# forward ports to the earthly runner on our docker host (TODO use env var)
ssh -N -L 8372:localhost:8372 18.191.162.117
# turn off tls as we're already working through SSH
echo 'global: {cache_size_mb: 24000, tls_enabled: false}' > ~/.earthly/config.yml
# needed as earthly special-cases localhost and 127.0.0.1 as a local buildkit
# give it meaningful name while we're at it
echo '127.0.0.1 earthly.remote' >> /etc/hosts