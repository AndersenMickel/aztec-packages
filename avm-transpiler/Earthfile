VERSION 0.8
IMPORT ../noir AS noir

source: #aztec-tag=cache
  ARG EARTHLY_TARGET_NAME
  # we rely on noir source, which this image has
  FROM noir+nargo

  # move noir contents to /usr/src/noir
  RUN mv /usr/src /noir && mkdir /usr/src && mv /noir /usr/src
  # work in avm-transpiler
  WORKDIR /usr/src/avm-transpiler

  COPY --dir scripts src Cargo.lock Cargo.toml rust-toolchain.toml .

  # for debugging rebuilds
  RUN echo CONTENT HASH $(find . -type f -exec sha256sum {} ';' | sort | sha256sum | awk '{print $1}') | tee .content-hash
  SAVE IMAGE --push aztecprotocol/cache:avm-transpiler-$EARTHLY_TARGET_NAME

build: #aztec-tag=cache
    ARG EARTHLY_TARGET_NAME
    FROM +source
    RUN ./scripts/bootstrap_native.sh
    SAVE ARTIFACT target/release/avm-transpiler avm-transpiler
    SAVE IMAGE --push aztecprotocol/cache:avm-transpiler-$EARTHLY_TARGET_NAME

run:
    #TODO needed?
    FROM ubuntu:focal
    COPY +build/avm-transpiler /usr/src/avm-transpiler
    ENTRYPOINT ["sh", "-c"]
